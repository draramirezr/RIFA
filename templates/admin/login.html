{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/login.css' %}">
  <style>
    /* Make admin login truly centered + responsive */
    body.login #nav-sidebar,
    body.login #toggle-nav-sidebar {
      display: none !important;
    }
    /* Avoid global admin width rules breaking login on mobile */
    body.login #container {
      width: auto !important;
      margin: 0 auto !important;
    }
    body.login #content {
      margin-left: 0 !important;
      max-width: none !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
    }
    body.login #content-main {
      float: none !important;
      width: auto !important;
      /* Mobile-first: use most of the screen width */
      width: min(92vw, 560px) !important;
      max-width: 560px;
      margin: 2.25rem auto;
      padding: 0;
    }
    body.login .breadcrumbs {
      max-width: min(92vw, 560px);
      margin-left: auto !important;
      margin-right: auto !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      box-sizing: border-box;
    }
    body.login .form-row label {
      float: none !important;
      width: auto !important;
      display: block;
      margin: 0 0 .35rem;
    }
    body.login .form-row input[type="text"],
    body.login .form-row input[type="password"] {
      width: 100% !important;
      box-sizing: border-box;
    }
    .gh-password-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
      max-width: 100%;
    }
    .gh-password-wrap input {
      flex: 1 1 auto;
      min-width: 0; /* critical to avoid overflow in flex */
    }
    .gh-password-wrap #togglePassword {
      flex: 0 0 auto;
      white-space: nowrap;
    }
    body.login .submit-row {
      display: flex;
      gap: .75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    body.login .password-reset-link {
      margin-top: .5rem;
    }
    #togglePassword.button {
      padding: .45rem .7rem;
    }
    @media (min-width: 900px) {
      body.login #content-main {
        width: min(520px, 92vw) !important;
      }
    }
  </style>
{% endblock %}

{% block bodyclass %}{{ block.super }} login{% endblock %}

{% block content %}
  <div id="content-main">
    {% if form.errors %}
      <p class="errornote">
        {% if form.errors.items|length == 1 %}{% translate "Por favor corrige el error de abajo." %}
        {% else %}{% translate "Por favor corrige los errores de abajo." %}{% endif %}
      </p>
    {% endif %}

    <form action="{{ app_path }}" method="post" id="login-form" novalidate>
      {% csrf_token %}

      <div class="form-row">
        {{ form.username.errors }}
        {{ form.username.label_tag }} {{ form.username }}
      </div>

      <div class="form-row">
        {{ form.password.errors }}
        <label for="{{ form.password.id_for_label }}">{% translate "Contraseña:" %}</label>
        <div class="gh-password-wrap">
          {{ form.password }}
          <button
            type="button"
            id="togglePassword"
            class="button"
            aria-controls="id_password"
            aria-pressed="false"
          >
            {% translate "Ver" %}
          </button>
        </div>
      </div>

      {% if next %}
        <input type="hidden" name="next" value="{{ next }}">
      {% endif %}

      <div class="submit-row">
        <input type="submit" value="{% translate 'Iniciar sesión' %}">
      </div>

      <div class="password-reset-link">
        {% url 'admin_password_reset' as reset_url %}
        {% url 'admin:password_change' as change_url %}
        <p style="margin: 10px 0 0;">
          {% if reset_url %}
            <a href="{{ reset_url }}">{% translate "¿Olvidaste tu contraseña?" %}</a>
          {% endif %}
        </p>
        <p style="margin: 6px 0 0; color: #6b7280;">
          {% translate "Después de iniciar sesión puedes cambiar tu contraseña aquí:" %}
          {% if change_url %}
            <a href="{{ change_url }}">{% translate "Cambiar contraseña" %}</a>
          {% endif %}
        </p>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const password = document.getElementById("id_password");
      const username = document.getElementById("id_username");
      const btn = document.getElementById("togglePassword");
      if (!password || !btn) return;

      // Make browser password saving more reliable
      if (username && !username.getAttribute("autocomplete")) username.setAttribute("autocomplete", "username");
      if (!password.getAttribute("autocomplete")) password.setAttribute("autocomplete", "current-password");

      function setState(show) {
        password.type = show ? "text" : "password";
        btn.textContent = show ? "{% translate 'Ocultar' %}" : "{% translate 'Ver' %}";
        btn.setAttribute("aria-pressed", show ? "true" : "false");
      }

      let showing = false;
      btn.addEventListener("click", function () {
        showing = !showing;
        setState(showing);
      });
    })();
  </script>
{% endblock %}

