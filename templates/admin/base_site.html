{% extends "admin/base.html" %}
{% load i18n static %}

{# Minimal override of Django admin base_site to inject login-only responsive tweaks #}

{% block title %}{{ title }} | {{ site_title|default:_("Administración") }}{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'dist/admin/admin.css' %}">
  <style>
    /* Apply ONLY on admin login */
    body.login #nav-sidebar,
    body.login #toggle-nav-sidebar {
      display: none !important;
    }
    body.login #content {
      margin-left: 0 !important;
    }
    body.login #content-main {
      float: none !important;
      width: min(92vw, 560px) !important;
      max-width: 560px;
      margin: 2.25rem auto;
      padding: 0 12px;
    }
    @media (min-width: 900px) {
      body.login #content-main {
        width: min(520px, 92vw) !important;
      }
    }
    body.login .form-row label {
      float: none !important;
      width: auto !important;
      display: block;
      margin: 0 0 .35rem;
    }
    body.login .form-row input[type="text"],
    body.login .form-row input[type="password"] {
      width: 100% !important;
      box-sizing: border-box;
    }
    body.login .submit-row {
      display: flex;
      gap: .75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Admin dashboard: make "Acciones recientes" collapsible */
    body.dashboard #recent-actions-module .recent-actions-toggle {
      float: right;
      font-size: 12px;
      padding: 2px 8px;
      line-height: 1.8;
      margin-top: -2px;
    }
    body.dashboard #recent-actions-module.is-collapsed .recent-actions-body {
      display: none;
    }
  </style>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    (function () {
      function onReady(fn) {
        if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
        else fn();
      }
      onReady(function () {
        if (!document.body) return;

        // Dashboard: collapsible recent actions
        if (document.body.classList.contains("dashboard")) {
          const module =
            document.getElementById("recent-actions-module") ||
            document.querySelector("#recent-actions-module.module") ||
            document.querySelector(".module#recent-actions-module");

          if (module) {
            const h2 = module.querySelector("h2");
            // Wrap body (everything except h2) so we can hide/show cleanly
            let body = module.querySelector(":scope > .recent-actions-body");
            if (!body) {
              body = document.createElement("div");
              body.className = "recent-actions-body";
              const toMove = [];
              Array.from(module.children).forEach((ch) => {
                if (h2 && ch === h2) return;
                toMove.push(ch);
              });
              toMove.forEach((ch) => body.appendChild(ch));
              module.appendChild(body);
            }

            const key = "admin_recent_actions_collapsed";
            const stored = localStorage.getItem(key);
            // Default: collapsed for everyone (admin can expand and we remember it).
            const initialCollapsed = stored === null ? true : stored === "1";

            function setCollapsed(collapsed) {
              module.classList.toggle("is-collapsed", collapsed);
              localStorage.setItem(key, collapsed ? "1" : "0");
              if (btn) btn.textContent = collapsed ? "{% translate 'Mostrar' %}" : "{% translate 'Ocultar' %}";
            }

            let btn = module.querySelector(".recent-actions-toggle");
            if (!btn && h2) {
              btn = document.createElement("button");
              btn.type = "button";
              btn.className = "button recent-actions-toggle";
              h2.appendChild(btn);
              btn.addEventListener("click", () => setCollapsed(!module.classList.contains("is-collapsed")));
            }
            setCollapsed(initialCollapsed);
          }
        }

        // Change list: collapse filters by default (user can expand)
        if (document.body.classList.contains("change-list")) {
          const filter = document.getElementById("changelist-filter");
          if (filter) {
            const key = "admin_filters_collapsed";
            const stored = localStorage.getItem(key);
            const initialCollapsed = stored === null ? true : stored === "1";

            // Wrap current content so we can hide/show
            let body = filter.querySelector(":scope > .gh-filter-body");
            if (!body) {
              body = document.createElement("div");
              body.className = "gh-filter-body";
              const toMove = [];
              Array.from(filter.children).forEach((ch) => {
                // keep the title if present
                if (ch.tagName && ch.tagName.toLowerCase() === "h2") return;
                toMove.push(ch);
              });
              toMove.forEach((ch) => body.appendChild(ch));
              filter.appendChild(body);
            }

            let h2 = filter.querySelector("h2");
            if (!h2) {
              h2 = document.createElement("h2");
              h2.textContent = "{% translate 'Filtros' %}";
              filter.insertBefore(h2, filter.firstChild);
            }

            let btn = filter.querySelector(".gh-filter-toggle");
            if (!btn) {
              btn = document.createElement("button");
              btn.type = "button";
              btn.className = "button gh-filter-toggle";
              btn.style.float = "right";
              btn.style.fontSize = "12px";
              btn.style.padding = "2px 8px";
              btn.style.lineHeight = "1.8";
              btn.style.marginTop = "-2px";
              h2.appendChild(btn);
            }

            function setCollapsed(collapsed) {
              filter.classList.toggle("is-collapsed", collapsed);
              localStorage.setItem(key, collapsed ? "1" : "0");
              btn.textContent = collapsed ? "{% translate 'Mostrar' %}" : "{% translate 'Ocultar' %}";
            }

            btn.addEventListener("click", () => setCollapsed(!filter.classList.contains("is-collapsed")));
            setCollapsed(initialCollapsed);

            // Collapse each filter group (h3 + its items) by default.
            try {
              const groups = Array.from(filter.querySelectorAll("h3"));
              const pageKey = location.pathname || "changelist";
              groups.forEach((h3, idx) => {
                const title = (h3.textContent || "").trim().replace(/\s+/g, " ").slice(0, 80) || String(idx);
                const gKey = `admin_filter_group_collapsed:${pageKey}:${idx}:${title}`;
                const gStored = localStorage.getItem(gKey);
                const gInitialCollapsed = gStored === null ? true : gStored === "1";

                // Wrap everything after h3 until next h3
                let body = h3.nextElementSibling;
                if (!body || body.classList.contains("gh-filter-group-body")) {
                  // already wrapped or unexpected structure
                  return;
                }
                const wrap = document.createElement("div");
                wrap.className = "gh-filter-group-body";
                const toMove = [];
                let cur = h3.nextElementSibling;
                while (cur && cur.tagName && cur.tagName.toLowerCase() !== "h3") {
                  const next = cur.nextElementSibling;
                  toMove.push(cur);
                  cur = next;
                }
                toMove.forEach((n) => wrap.appendChild(n));
                h3.insertAdjacentElement("afterend", wrap);

                let gBtn = h3.querySelector(".gh-filter-group-toggle");
                if (!gBtn) {
                  gBtn = document.createElement("button");
                  gBtn.type = "button";
                  gBtn.className = "button gh-filter-group-toggle";
                  gBtn.style.float = "right";
                  gBtn.style.fontSize = "11px";
                  gBtn.style.padding = "1px 8px";
                  gBtn.style.lineHeight = "1.8";
                  gBtn.style.marginTop = "-2px";
                  h3.appendChild(gBtn);
                }

                function setGroupCollapsed(collapsed) {
                  h3.classList.toggle("is-collapsed", collapsed);
                  wrap.classList.toggle("is-collapsed", collapsed);
                  localStorage.setItem(gKey, collapsed ? "1" : "0");
                  gBtn.textContent = collapsed ? "{% translate 'Mostrar' %}" : "{% translate 'Ocultar' %}";
                }

                gBtn.addEventListener("click", () => setGroupCollapsed(!wrap.classList.contains("is-collapsed")));
                setGroupCollapsed(gInitialCollapsed);
              });
            } catch (e) {
              // ignore
            }
          }
        }

        // Login: show/hide password
        if (!document.body.classList.contains("login")) return;

        const username = document.getElementById("id_username");
        const password = document.getElementById("id_password");
        if (!password) return;

        // Help browsers save passwords
        if (username && !username.getAttribute("autocomplete")) username.setAttribute("autocomplete", "username");
        if (!password.getAttribute("autocomplete")) password.setAttribute("autocomplete", "current-password");

        // Add a simple show/hide button if it doesn't exist
        if (document.getElementById("togglePassword")) return;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.id = "togglePassword";
        btn.className = "button";
        btn.style.marginLeft = "8px";
        btn.textContent = "{% translate 'Ver' %}";

        let showing = false;
        btn.addEventListener("click", function () {
          showing = !showing;
          password.type = showing ? "text" : "password";
          btn.textContent = showing ? "{% translate 'Ocultar' %}" : "{% translate 'Ver' %}";
        });

        password.insertAdjacentElement("afterend", btn);
      });
    })();
  </script>
{% endblock %}

{% block branding %}
  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
    <h1 id="site-name" style="margin:0;">
      <a href="{% url 'admin:index' %}">{{ site_header|default:_("Administración") }}</a>
    </h1>
    {% if request.user.is_staff %}
      <div class="gh-admin-tools" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:2px;">
      <a href="{% url 'admin_winner_search' %}" class="button" style="margin:0;">
        {% translate "Buscar boleto ganador" %}
      </a>
      <a href="{% url 'admin_raffle_calculator' %}" class="button default" style="margin:0;">
        {% translate "Calculadora de rifa" %}
      </a>
      <a href="{% url 'admin_raffle_performance' %}" class="button" style="margin:0;">
        {% translate "Rendimiento de rifa" %}
      </a>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block nav-global %}{% endblock %}

